{% extends "sanza/_bs_section.html" %}
{% load i18n pagination_tags sanza_utils %}

{% block section_title %}
  {% trans "Search results" %} :
  {% if entities_count > 1 %}{{entities_count}} {% trans "entities" %}{% else %}{{entities_count}} {% trans "entity" %}{% endif %} -
  {% if contacts_count > 1 %}{{contacts_count}} {% trans "contacts" %}{% else %}{{contacts_count}} {% trans "contact" %}{% endif %}
  
{% endblock %}
  
{% block section_data %}
{% if entities %}
  {% if has_empty_entities %}
    <div class="warning">{% trans "The search contains empty entities: These entities may only have secondary or old contacts" %}</div>
  {% endif %}
  {% autopaginate entities nb_entities_by_page %}
  <table class="table table-bordered font-small">
    <tr><th colspan=2>{% trans "Contacts" %}</th></tr>
  {% for e in entities %}
    <tr class="{% if forloop.counter|divisibleby:2 %}even{% else %}odd{% endif %}">
      {% if not e.single_contact %}
        <td><a href="{{e.get_absolute_url}}">{{e.name}}</a>
        {% if e.is_empty %}
          <td class="empty-entity">
            {% trans "No contacts !!" %}
          </td>
        {% else %}
          <td>
        {% endif %}
      {% else %}
        <td colspan=2>
      {% endif %}
        
      {% with e.search_contacts as contacts %}
      {% if contacts %}
        {% for c in contacts %}
          <div class="contact contact-sr">
            <a href="{{c.get_absolute_url}}">{{c.fullname}}</a>&nbsp;{{ c.get_roles|seq_to_dash }}&nbsp;</a>
            {% if c.get_email %}<a href="mailto:{{c.get_email}}">{{c.get_email}}</a>{% endif %}
            <a class="btn btn-xs btn-warning pull-right" href="" class="exclude-contact" rel="{{c.id}}">
              <span class="glyphicon glyphicon-remove-sign"></span> {% trans "exclude" %}
            </a>
          </div>
        {% endfor %}
      {% else %}
        &nbsp;
      {% endif %}
      {% endwith %}
      </td>
    </tr>
  {% endfor %}
  </table>
  {% paginate %}
  <script>
    $(function() {
      $('a.exclude-contact').live('click', function() {
        var val = $("input[name=excluded]").val();
        var cid = '#'+$(this).attr('rel')+'#';
        if (val.search(cid) >= 0) {
          $(this).parent().removeClass('excluded');
          val = val.replace('#'+$(this).attr('rel')+'#', '');
        } else {
          $(this).parent().addClass('excluded');
          val += '#'+$(this).attr('rel')+'#';
        }
        $("input[name=excluded]").val(val);
        return false;
      });
      $(".mailto-button").click(function() {
        $("form.search-form").attr('action', $(this).attr('href'));
        $("form.search-form").attr('target', '_blank');
        $("form.search-form").submit();
        $("form.search-form").attr('action', '');
        $("form.search-form").removeAttr('target');
        return false;
      });
      $("#emailing-button").click(function() {
        {% if contains_refuse_newsletter %}
        var letsgo = confirm(
          '{% trans "The search results contains contacts who are refusing the newsletter.\n\nContinue?" %}'
        );
        if (!letsgo) {
          return false;
        }
        {% endif %}
        $("form.search-form").colorboxSubmit({href: $(this).attr('href')});
        $("form.search-form").attr('action', '');
        return false;
      });
      
      $("#xl-button").click(function() {
        $("form.search-form").attr('action', $(this).attr('href'));
        $("form.search-form").attr('target', '_blank');
        $("form.search-form").submit();
        $("form.search-form").attr('action', '');
        $("form.search-form").removeAttr('target');
        return false;
      });
      
      $(".action-button").click(function() {
        $("form.search-form").colorboxSubmit({href: $(this).attr('href')});
        $("form.search-form").attr('action', '');
        return false;
      });
      
      $(".pagination a").live('click', function() {
        $("form.search-form").attr('action', $(this).attr('href'));
        $("form.search-form").submit();
        $("form.search-form").attr('action', '');
        return false;
      });
      
      var excluded = $("input[name=excluded]").val()
      excluded = excluded.substring(1, excluded.length-1).split("##");
      for (var i=0, n=excluded.length; i<n; i++) {
        $('a.exclude-contact[rel='+excluded[i]+']').parent().addClass('excluded');
      };
    })
  </script>
{% else %}
  {{ message }}
{% endif %}

{% endblock %}

{% block section_buttons %}
  
{% if entities %}
<li><a href="{% url "search_mailto_contacts" 0 %}" class="mailto-button">{% trans "Mail to" %}</a></li>
<li><a href="{% url "search_mailto_contacts" 1 %}" class="mailto-button">{% trans "BCC Mail to" %}</a></li>
<li><a href="{% url "search_emailing" %}" id="emailing-button">{% trans "Mailing" %}</a></li>
<li><a href="{% url "search_export_contacts_as_excel" %}" id="xl-button">{% trans "Excel" %}</a></li>
<li><a href="{% url "search_create_action_for_contacts" %}" class="action-button" class="colorbox-form">{% trans "Create action" %}</a></li>
<li><a href="{% url "search_add_contacts_to_group" %}" class="action-button" class="colorbox-form">{% trans "Add to groups" %}</a></li>
<li><a href="{% url "search_export_to_pdf" %}" class="action-button" class="colorbox-form">{% trans "PDF" %}</a></li>

{% if user.is_superuser %}<li><a href="{% url "search_contacts_admin" %}" class="action-button" class="colorbox-form">{% trans "Contacts Admin" %}</a></li>{% endif %}
{% endif %}
{% endblock %}
